@using System.Globalization
@using AmwajGrocery.Models
@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor

@{
    var currentCulture = CultureInfo.CurrentUICulture.Name;
    var isAr = currentCulture.StartsWith("ar");
    ViewData["Title"] = isAr ? "الرئيسية" : "Home";

    var deals = ViewBag.Deals as List<Product>;
    var bestSellers = ViewBag.BestSellers as List<Product>;
    var categories = ViewBag.Categories as List<Category>;
    var defaultImage = "/images/logo-removebg-preview (3).png";
}

<div class="container" style="padding-top: 20px;">

    <section class="page-section">
        <h2 style="color: var(--amwaj-accent); border-bottom: 2px solid var(--amwaj-accent); padding-bottom: 10px;">
            @(isAr ? "عروض وتخفيضات اليوم" : "Today's Deals")
        </h2>
        <div class="product-grid">
            @if (deals != null && deals.Any())
            {
                foreach (var item in deals)
                {
                    <partial name="_ProductCard" model="item" />
                }
            }
            else
            {
                <p style="text-align:center; color:#777; width:100%;">@(isAr ? "لا توجد عروض حالياً." : "No deals available.")</p>
            }
        </div>
    </section>

    <section class="page-section" style="background-color: #fff; padding: 20px; border-radius: 10px;">
        <h2 style="color: var(--amwaj-text-dark);">@(isAr ? "تسوق حسب الفئة" : "Shop by Category")</h2>
        <div class="category-grid">
            @if (categories != null)
            {
                foreach (var cat in categories)
                {
                    var displayCatName = isAr ? cat.NameAr : (string.IsNullOrEmpty(cat.NameEn) ? cat.NameAr : cat.NameEn);
                    <div class="category-card" onclick="location.href='/Home/Products?categoryId=@cat.Id'">
                        <img src="@GetImageSrc(cat.ImageUrl)" alt="@displayCatName" referrerpolicy="no-referrer" loading="lazy" onerror="this.src='@defaultImage'">
                        <h4>@displayCatName</h4>
                        <p style="font-size: 0.8em; color: #777;">(@(cat.Products?.Count() ?? 0))</p>
                    </div>
                }
            }
        </div>
    </section>

    <section class="page-section">
        <h2 style="color: var(--amwaj-primary);">@(isAr ? "الأكثر مبيعاً" : "Best Sellers")</h2>
        <div class="product-grid">
            @if (bestSellers != null && bestSellers.Any())
            {
                foreach (var item in bestSellers)
                {
                    <partial name="_ProductCard" model="item" />
                }
            }
        </div>
    </section>
</div>

@functions {
    public string GetImageSrc(string url)
    {
        string defaultImg = "/images/logo-removebg-preview (3).png";
        if (string.IsNullOrEmpty(url)) return defaultImg;
        if (url.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return url;
        var cleanUrl = url.TrimStart('/');
        if (!cleanUrl.StartsWith("images/", StringComparison.OrdinalIgnoreCase)) return "/images/" + cleanUrl;
        return "/" + cleanUrl;
    }
}