@using AmwajGrocery.Models
@model IEnumerable<AmwajGrocery.Models.Order>
@{
    ViewData["Title"] = "إدارة الطلبات";

    int currentPage = ViewBag.CurrentPage;
    int totalPages = ViewBag.TotalPages;
    string searchTerm = ViewBag.SearchTerm;
}

<div class="container" style="padding-top: 40px;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h2 style="margin-bottom: 5px; border: none;">📦 إدارة الطلبات</h2>
            <p style="color: #777; margin: 0;">متابعة طلبات الواتساب وتحديث حالتها</p>
        </div>
        <a href="/Admin/Dashboard" style="background: #f1f2f6; color: #333; padding: 10px 20px; border-radius: 50px; font-weight: bold; transition: 0.3s;">
            <i class="fas fa-arrow-right"></i> لوحة التحكم
        </a>
    </div>

    <form method="get" action="/Admin/Orders" style="margin-bottom: 20px;">
        <div style="position: relative; max-width: 400px;">
            <input type="text" name="search" value="@searchTerm" placeholder="بحث برقم الطلب..."
                   style="width: 100%; padding: 10px 40px 10px 15px; border: 1px solid #ddd; border-radius: 25px; outline: none;">
            <button type="submit" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--amwaj-primary);">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </form>

    <div class="table-container">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>التاريخ</th>
                    <th>المنتجات</th>
                    <th>الإجمالي</th>
                    <th>الحالة</th>
                    <th style="text-align: center;">إجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model)
                {
                    string rowColor = "";
                    if (order.Status == OrderStatus.NotResponded) rowColor = "border-right: 5px solid orange;";
                    if (order.Status == OrderStatus.Paid) rowColor = "border-right: 5px solid green;";
                    if (order.Status == OrderStatus.Cancelled) rowColor = "border-right: 5px solid red;";
                    if (order.Status == OrderStatus.Blacklist) rowColor = "border-right: 5px solid black; background-color: #f0f0f0;";

                    <tr class="order-row" style="@rowColor">
                        <td style="font-weight: bold; color: var(--amwaj-secondary);">#@order.Id</td>
                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <span style="font-weight: bold;">@order.OrderDate.ToString("yyyy/MM/dd")</span>
                                <span style="font-size: 0.85em; color: #999;">@order.OrderDate.ToString("hh:mm tt")</span>
                            </div>
                        </td>
                        <td style="max-width: 300px;">
                            <div class="order-items-list">
                                @foreach (var item in order.OrderItems)
                                {
                                    <span class="order-item-badge">@item.ProductName <small>x @item.Quantity</small></span>
                                }
                            </div>
                        </td>
                        <td style="font-weight: 900; color: var(--amwaj-text-dark);">
                            @order.TotalAmount.ToString("F3") ر.ع
                        </td>
                        <td>
                            <form action="/Admin/UpdateOrderStatus" method="post" class="status-form">
                                <input type="hidden" name="id" value="@order.Id" />
                                <select name="status" onchange="this.form.submit()" class="status-select @GetStatusClass(order.Status)">
                                    <option value="0" selected="@(order.Status == OrderStatus.NotResponded ? "selected" : null)">⏳ لم يتم الرد</option>
                                    <option value="1" selected="@(order.Status == OrderStatus.Paid ? "selected" : null)">✅ مدفوع</option>
                                    <option value="2" selected="@(order.Status == OrderStatus.Cancelled ? "selected" : null)">❌ ملغي</option>
                                    <option value="3" selected="@(order.Status == OrderStatus.Blacklist ? "selected" : null)">🚫 قائمة سوداء</option>
                                </select>
                            </form>
                        </td>
                        <td style="text-align: center;">
                            <form action="/Admin/DeleteOrder" method="post" onsubmit="return confirm('هل أنت متأكد من حذف هذا الطلب نهائياً؟');" style="display: inline-block;">
                                <input type="hidden" name="id" value="@order.Id" />
                                <button type="submit" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                            <a href="https://api.whatsapp.com/send?phone=96896755118" target="_blank" class="action-btn whatsapp" title="تواصل واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (totalPages > 1)
    {
        <div style="margin-top: 20px; display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;">
            @if (currentPage > 1)
            {
                <a href="/Admin/Orders?page=@(currentPage - 1)&search=@searchTerm" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; background: white;">&laquo; السابق</a>
            }

            @{
                int startPage = Math.Max(1, currentPage - 2);
                int endPage = Math.Min(totalPages, currentPage + 2);

                if (startPage > 1)
                {
                    <a href="/Admin/Orders?page=1&search=@searchTerm" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; background: white;">1</a>
                    if (startPage > 2)
                    {

                        <span style="padding: 8px;">...</span>
                    }
                }

                for (int i = startPage; i <= endPage; i++)
                {
                    <a href="/Admin/Orders?page=@i&search=@searchTerm"
                       style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; @(i == currentPage ? "background: var(--amwaj-primary); color: white; border-color: var(--amwaj-primary);" : "background: white;")">
                        @i
                    </a>
                }

                if (endPage < totalPages)
                {
                    if (endPage < totalPages - 1)
                    {

                        <span style="padding: 8px;">...</span>
                    }
                    <a href="/Admin/Orders?page=@totalPages&search=@searchTerm" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; background: white;">@totalPages</a>
                }
            }

            @if (currentPage < totalPages)
            {
                <a href="/Admin/Orders?page=@(currentPage + 1)&search=@searchTerm" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 5px; background: white;">التالي &raquo;</a>
            }
        </div>
    }
</div>

@functions {
    string GetStatusClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.NotResponded => "status-pending",
            OrderStatus.Paid => "status-paid",
            OrderStatus.Cancelled => "status-cancelled",
            OrderStatus.Blacklist => "status-blacklist",
            _ => ""
        };
    }
}