@using AmwajGrocery.Models
@model IEnumerable<AmwajGrocery.Models.Order>
@{
    ViewData["Title"] = "إدارة الطلبات";

    // حسابات للإحصائيات
    var totalOrders = Model.Count();
    var pendingOrders = Model.Count(o => o.Status == OrderStatus.NotResponded);
    var totalRevenue = Model.Where(o => o.Status != OrderStatus.Cancelled).Sum(o => o.TotalAmount);
}

<div class="container" style="padding-top: 40px;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <div>
            <h2 style="margin-bottom: 5px; border: none;">📦 إدارة الطلبات</h2>
            <p style="color: #777; margin: 0;">متابعة طلبات الواتساب وتحديث حالتها</p>
        </div>
        <a href="/Admin/Dashboard" style="background: #f1f2f6; color: #333; padding: 10px 20px; border-radius: 50px; font-weight: bold; transition: 0.3s;">
            <i class="fas fa-arrow-right"></i> لوحة التحكم
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon" style="background: #e0f2f1; color: var(--amwaj-primary);"><i class="fas fa-receipt"></i></div>
            <div class="info">
                <h4>@totalOrders</h4>
                <p>إجمالي الطلبات</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="icon" style="background: #fff3e0; color: var(--amwaj-accent);"><i class="fas fa-clock"></i></div>
            <div class="info">
                <h4>@pendingOrders</h4>
                <p>قيد الانتظار</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="icon" style="background: #e8f5e9; color: var(--amwaj-green);"><i class="fas fa-money-bill-wave"></i></div>
            <div class="info">
                <h4>@totalRevenue.ToString("F3")</h4>
                <p>إجمالي الإيرادات (ر.ع)</p>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="table-container">
        <table class="orders-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>التاريخ</th>
                    <th>المنتجات</th>
                    <th>الإجمالي</th>
                    <th>الحالة</th>
                    <th style="text-align: center;">إجراءات</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var order in Model)
                {
                    <tr class="order-row">
                        <td style="font-weight: bold; color: var(--amwaj-secondary);">#@order.Id</td>

                        <td>
                            <div style="display: flex; flex-direction: column;">
                                <span style="font-weight: bold;">@order.OrderDate.ToString("yyyy/MM/dd")</span>
                                <span style="font-size: 0.85em; color: #999;">@order.OrderDate.ToString("hh:mm tt")</span>
                            </div>
                        </td>

                        <td style="max-width: 300px;">
                            <div class="order-items-list">
                                @foreach (var item in order.OrderItems)
                                {
                                    <span class="order-item-badge">@item.ProductName <small>x @item.Quantity</small></span>
                                }
                            </div>
                        </td>

                        <td style="font-weight: 900; color: var(--amwaj-text-dark);">
                            @order.TotalAmount.ToString("F3") ر.ع
                        </td>

                        <td>
                            <form action="/Admin/UpdateOrderStatus" method="post" class="status-form">
                                <input type="hidden" name="id" value="@order.Id" />
                                <select name="status" onchange="this.form.submit()" class="status-select @GetStatusClass(order.Status)">
                                    <option value="0" selected="@(order.Status == OrderStatus.NotResponded ? "selected" : null)">⏳ لم يتم الرد</option>
                                    <option value="1" selected="@(order.Status == OrderStatus.Paid ? "selected" : null)">✅ مدفوع</option>
                                    <option value="2" selected="@(order.Status == OrderStatus.Cancelled ? "selected" : null)">❌ ملغي</option>
                                    <option value="3" selected="@(order.Status == OrderStatus.Blacklist ? "selected" : null)">🚫 قائمة سوداء</option>
                                </select>
                            </form>
                        </td>

                        <td style="text-align: center;">
                            <form action="/Admin/DeleteOrder" method="post" onsubmit="return confirm('هل أنت متأكد من حذف هذا الطلب نهائياً؟');" style="display: inline-block;">
                                <input type="hidden" name="id" value="@order.Id" />
                                <button type="submit" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                            <a href="https://api.whatsapp.com/send?phone=96896755118" target="_blank" class="action-btn whatsapp" title="تواصل واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@functions {
    string GetStatusClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.NotResponded => "status-pending",
            OrderStatus.Paid => "status-paid",
            OrderStatus.Cancelled => "status-cancelled",
            OrderStatus.Blacklist => "status-blacklist",
            _ => ""
        };
    }
}